<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Application Detail - Responsible AI Explorer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="bg-light">
  <div class="container my-5">
    <a href="/welcome.html" class="btn btn-secondary mb-3" aria-label="Back to sectors">‚Üê Back</a>
    <h1 id="app-title" class="display-5"></h1>
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#desc" role="tab">Description</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#challenges" role="tab">Ethical Challenges</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#principles" role="tab">Principles</a></li>
    </ul>
    <div class="tab-content mt-3">
      <div class="tab-pane active" id="desc"></div>
      <div class="tab-pane" id="challenges"></div>
      <div class="tab-pane" id="principles"></div>
    </div>
    <button class="btn btn-lg btn-success mt-3" data-bs-toggle="modal" data-bs-target="#assessModal">Start Assessment</button>
    <div class="modal fade" id="assessModal" tabindex="-1" aria-modal="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Run Assessment</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="assess-form" enctype="multipart/form-data">
              <div class="mb-3">
                <label for="dataset" class="form-label">Select or Upload Dataset (CSV)</label>
                <select name="dataset_id" class="form-control mb-2" id="dataset-select">
                  <option value="">Upload Custom Dataset</option>
                </select>
                <input type="file" name="dataset" class="form-control" accept=".csv" id="dataset-file" style="display: none;">
              </div>
              <div class="mb-3">
                <label for="model_type" class="form-label">Model Type</label>
                <select name="model_type" class="form-control" required>
                  <option value="logistic_regression">Logistic Regression</option>
                  <option value="random_forest">Random Forest</option>
                  <option value="xgboost">XGBoost</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="principles" class="form-label">Select Principles</label>
                <select name="principles" class="form-control" multiple required>
                  <option value="fairness">Fairness</option>
                  <option value="transparency">Transparency</option>
                  <option value="privacy">Privacy</option>
                </select>
              </div>
              <div class="progress mt-3" style="display: none;" id="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" id="progress-bar"></div>
              </div>
              <div id="error-message" class="text-danger mt-3" style="display: none;"></div>
              <button type="submit" class="btn btn-primary">Submit</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    async function loadApplication() {
      const params = new URLSearchParams(window.location.search);
      const appId = params.get('id');
      const sectorId = params.get('sector');
      try {
        const [appRes, datasetsRes] = await Promise.all([
          fetch(`/api/applications/${appId}`),
          fetch(`/api/datasets?sector=${sectorId}`)
        ]);
        const data = await appRes.json();
        const datasets = await datasetsRes.json();
        document.getElementById('app-title').textContent = data.name;
        document.getElementById('desc').textContent = data.description;
        document.getElementById('challenges').textContent = data.challenges;
        document.getElementById('principles').innerHTML = data.principles.map(p => `<span class="badge bg-primary me-1">${p}</span>`).join('');
        const datasetSelect = document.getElementById('dataset-select');
        datasets.forEach(ds => {
          datasetSelect.innerHTML += `<option value="${ds.id}">${ds.name}</option>`;
        });
        datasetSelect.addEventListener('change', e => {
          document.getElementById('dataset-file').style.display = e.target.value ? 'none' : 'block';
        });
      } catch (err) {
        console.error('Failed to load application:', err);
      }
    }
    document.getElementById('assess-form').addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const progressBar = document.getElementById('progress-bar');
      const errorMessage = document.getElementById('error-message');
      document.getElementById('progress').style.display = 'block';
      try {
        const res = await fetch('/api/assess', { method: 'POST', body: formData });
        const result = await res.json();
        if (result.error) {
          errorMessage.style.display = 'block';
          errorMessage.textContent = result.error;
          document.getElementById('progress').style.display = 'none';
        } else {
          const interval = setInterval(async () => {
            const status = await fetch(`/api/assess/status/${result.reportId}`).then(r => r.json());
            progressBar.style.width = `${status.progress}%`;
            if (status.progress === 100) {
              clearInterval(interval);
              window.location.href = `/report.html?id=${result.reportId}`;
            }
          }, 1000);
        }
      } catch (err) {
        errorMessage.style.display = 'block';
        errorMessage.textContent = 'Server error';
        document.getElementById('progress').style.display = 'none';
      }
    });
    loadApplication();
  </script>
</body>
</html>